CREATE DATABASE EX4
--PHẦN 1
CREATE TABLE THELOAI(
	MATHELOAI VARCHAR(6) NOT NULL,
	PRIMARY KEY(MATHELOAI),
	TENTHELOAI VARCHAR(15) UNIQUE NOT NULL
);

CREATE TABLE SACH(
	MASACH VARCHAR(6) NOT NULL,
	PRIMARY KEY (MASACH),
	TENSACH VARCHAR(30) UNIQUE NOT NULL,
	NAMXUATBAN INT CHECK(NAMXUATBAN BETWEEN 1800 AND 2023) NOT NULL,
	MATHELOAI VARCHAR(6) NOT NULL, 
	FOREIGN KEY(MATHELOAI) REFERENCES THELOAI(MATHELOAI)
);

CREATE TABLE BANDOC(
	MABANDOC VARCHAR(6) NOT NULL,
	PRIMARY KEY (MABANDOC),
	TENBANDOC VARCHAR(30) NOT NULL,
	NAGYSINH DATETIME NOT NULL,
	DIACHI VARCHAR(30) NOT NULL
);

CREATE TABLE PHIEUMUON(
	MAMUON VARCHAR(6) NOT NULL,
	PRIMARY KEY (MAMUON),
	MABANDOC VARCHAR(6) NOT NULL,
	FOREIGN KEY(MABANDOC) REFERENCES BANDOC(MABANDOC) on delete cascade,
	MASACH VARCHAR(6) NOT NULL,
	FOREIGN KEY(MASACH) REFERENCES SACH(MASACH) ,
	NGAYMUON DATETIME ,
	NGAYTRA DATETIME ,
);

CREATE TABLE PHIEUTRA(
	MAPHIEUTRA VARCHAR(6) NOT NULL,
	PRIMARY KEY(MAPHIEUTRA),
	MAPHIEUMUON VARCHAR(6) NOT NULL,
	FOREIGN KEY(MAPHIEUMUON) REFERENCES PHIEUMUON(MAMUON) on delete cascade,
	NGAYTRATHUCTE DATETIME 
);

ALTER TABLE PHIEUMUON ALTER COLUMN NGAYTRA DATETIME
ALTER TABLE PHIEUTRA ALTER COLUMN NGAYTRATHUCTE DATETIME
-- PHẦN 2
-- THÊM DỮ LIỆU
INSERT INTO THELOAI VALUES ('TL001','TRUYEN TRANH')
INSERT INTO THELOAI VALUES ('TL002','VAN HOC')
INSERT INTO THELOAI VALUES ('TL003','HOC THUAT')

INSERT INTO SACH VALUES ('MS001','DORAEMON',2000,'TL001')
INSERT INTO SACH VALUES ('MS002','SHIN CAU BE BUT CHIF',2004,'TL001')
INSERT INTO SACH VALUES ('MS003','TOI YEU EM',2014,'TL002')
INSERT INTO SACH VALUES ('MS004','CAU TRUC DU LIEU',1994,'TL003')
INSERT INTO SACH VALUES ('MS005','LAP TRINH JAVA',1974,'TL003')

INSERT INTO BANDOC VALUES ('001','HUYNH VAN CHI','10/22/1957','555 MAI AN TIEN HA NOI')
INSERT INTO BANDOC VALUES ('002','VUONG NGOC','07/10/2002','543 MAI THI LUU Q1 TPHCM')
INSERT INTO BANDOC VALUES ('003','CO LUC NA','05/22/2014','638 NGUYEN VAN CU Q5 TPHCM')

INSERT INTO PHIEUMUON VALUES ('PM001','002','MS001','05/30/2023','06/19/2023')
INSERT INTO PHIEUMUON VALUES ('PM002','001','MS003','07/10/2023','07/17/2023')
INSERT INTO PHIEUMUON VALUES ('PM003','002','MS002','07/31/2023','08/15/2023')
INSERT INTO PHIEUMUON VALUES ('PM004','001','MS001','10/31/2023','06/02/2023')
INSERT INTO PHIEUMUON VALUES ('PM005','003','MS005','04/02/2023','05/02/2023')

INSERT INTO PHIEUTRA VALUES ('PT001','PM001','05/02/2023')
INSERT INTO PHIEUTRA VALUES ('PT002','PM003',NULL)
INSERT INTO PHIEUTRA VALUES ('PT003','PM002',NULL)
INSERT INTO PHIEUTRA VALUES ('PT004','PM004','06/03/2023')
INSERT INTO PHIEUTRA VALUES ('PT005','PM005','05/03/2023')

-- XOÁ BẠN ĐỌC DƯỚI 18 TUỔI
SELECT BANDOC.TENBANDOC, BANDOC.NAGYSINH 
FROM BANDOC
DELETE FROM BANDOC
WHERE (YEAR(GETDATE())-YEAR(BANDOC.NAGYSINH)) < 18
SELECT BANDOC.TENBANDOC, BANDOC.NAGYSINH 
FROM BANDOC

--TĂNG NGÀY MƯỢN CHO PHIẾU MƯỢN CÓ NGÀY NƯỢN SAU 31/10/2023
SELECT PHIEUMUON.MABANDOC, PHIEUMUON.NGAYMUON
FROM PHIEUMUON
UPDATE PHIEUMUON SET PHIEUMUON.NGAYMUON = DATEADD(DAY,7,PHIEUMUON.NGAYTRA)
WHERE PHIEUMUON.NGAYMUON>'10/31/2023'
SELECT PHIEUMUON.MABANDOC, PHIEUMUON.NGAYMUON
FROM PHIEUMUON
--PHẦN 3
-- LIỆT KÊ CÁC THỂ LOẠI SÁCH
SELECT THELOAI.TENTHELOAI 
FROM THELOAI

--LIỆT KÊ CÁC BẠN ĐỌC CHỈ Ở HÀ NỘI
SELECT BANDOC.TENBANDOC FROM BANDOC
WHERE BANDOC.DIACHI LIKE '%HA NOI'

--LIỆT KÊ CÁC SÁCH ĐƯỢC MƯỢN MÀ CHƯA TRẢ
SELECT SACH.TENSACH FROM SACH
INNER JOIN PHIEUMUON ON PHIEUMUON.MASACH=SACH.MASACH
INNER JOIN PHIEUTRA ON PHIEUTRA.MAPHIEUMUON=PHIEUMUON.MAMUON
WHERE PHIEUTRA.NGAYTRATHUCTE IS NULL

--LIỆT KÊ TÊN SÁCH VÀ SỐ LẦN MƯỢN
SELECT SACH.TENSACH, COUNT(PHIEUMUON.MASACH) AS SOLANMUON
FROM SACH 
LEFT JOIN PHIEUMUON  ON SACH.MASACH = PHIEUMUON.MASACH
GROUP BY SACH.TENSACH

--TÌM SỐ LƯỢNG SÁCH CHƯA ĐƯỢC MƯỢN ÍT NHẤT 1 LẦN
SELECT COUNT(*) AS SOLUONGSACHCHUAMUON
FROM SACH
WHERE SACH.MASACH NOT IN (SELECT DISTINCT PHIEUMUON.MASACH FROM PHIEUMUON);

--TÌM SỐ LƯỢNG SÁCH ĐƯỢC MƯỢN ÍT NHẤT 1 LẦN
SELECT COUNT(*) AS SOLUONGSACHDAMUON
FROM SACH
WHERE SACH.MASACH IN (SELECT DISTINCT PHIEUMUON.MASACH FROM PHIEUMUON);

